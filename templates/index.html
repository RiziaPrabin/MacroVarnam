<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnackTrack & JamHack</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>

<body>

    <main class="container">
        <header>
            <h1>SnackTrack & JamHack ðŸŽµ</h1>
            <p>The AI companion ensuring your vibes, snacks, and beats are always in perfect alignment.</p>
        </header>

        <section id="analyzer">
            <div class="video-container">
                <video id="webcam" autoplay playsinline></video>
                <div id="overlay" class="hidden">
                    <div class="spinner"></div>
                    <p>Analyzing your vibe...</p>
                </div>
            </div>
            <button id="capture-btn">Analyze My Mood</button>
        </section>

        <section id="results" class="hidden">
            <h2>Your Official Mood Menu</h2>
            <div class="result-card">
                <div class="mood-detected">
                    <span id="mood-emoji"></span>
                    <h3 id="mood-text"></h3>
                </div>
                <p class="diagnosis" id="mood-message"></p>

                <!-- === HTML MODIFICATION START === -->
                <!-- We now have dedicated containers for the video and the image -->
                <div class="pairing">
                    <div class="recommendation">
                        <h4>ðŸŽµ JamHack Music</h4>
                        <!-- This div will hold the YouTube iframe -->
                        <div id="music-container"></div>
                        <p id="music-rec-text"></p>
                    </div>
                    <div class="recommendation">
                        <h4>SnackTrack</h4>
                        <!-- This div will hold the food image -->
                        <div id="snack-container"></div>
                        <p id="snack-rec-text"></p>
                    </div>
                </div>
                <!-- === HTML MODIFICATION END === -->

            </div>
        </section>

    </main>

    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        // --- DOM Elements ---
        const webcamElement = document.getElementById('webcam');
        const canvasElement = document.getElementById('canvas');
        const captureBtn = document.getElementById('capture-btn');
        const resultsSection = document.getElementById('results');
        const overlay = document.getElementById('overlay');

        // --- Initialize Webcam ---
        async function setupWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                webcamElement.srcObject = stream;
            } catch (err) {
                console.error("Error accessing webcam: ", err);
                // Replaced alert with a console log to avoid blocking UI in some environments
                console.error("Could not access your webcam. Please enable it in your browser settings.");
            }
        }

        // --- Capture and Analyze Mood ---
        captureBtn.addEventListener('click', async () => {
            // 1. Show loading overlay
            overlay.classList.remove('hidden');
            resultsSection.classList.add('hidden');
            captureBtn.disabled = true;
            captureBtn.textContent = 'Analyzing...';

            // 2. Capture frame from video to canvas
            const context = canvasElement.getContext('2d');
            canvasElement.width = webcamElement.videoWidth;
            canvasElement.height = webcamElement.videoHeight;
            context.drawImage(webcamElement, 0, 0, canvasElement.width, canvasElement.height);

            // 3. Convert canvas image to Base64 data URL
            const imageDataURL = canvasElement.toDataURL('image/jpeg');

            // 4. Send image data to the Flask backend
            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageDataURL })
                });

                if (!response.ok) {
                    throw new Error(Server error: ${response.status});
                }

                const data = await response.json();

                // 5. Display the results
                displayResults(data);

            } catch (error) {
                console.error('Error during analysis:', error);
                // Replaced alert with a console log
                console.error('An error occurred. Please try again.');
            } finally {
                // 6. Hide loading overlay and re-enable button
                overlay.classList.add('hidden');
                captureBtn.disabled = false;
                captureBtn.textContent = 'Analyze My Mood Again';
            }
        });

        // === JAVASCRIPT MODIFICATION START ===
        function displayResults(data) {
            if (!data || !data.recommendation) {
                console.error("Invalid data received from server:", data);
                return;
            }
            const { mood, recommendation } = data;

            // --- Update Text Content ---
            document.getElementById('mood-emoji').textContent = recommendation.emoji || 'ðŸ¤”';
            document.getElementById('mood-text').textContent = mood.charAt(0).toUpperCase() + mood.slice(1);
            document.getElementById('mood-message').textContent = "${recommendation.message}";

            // --- Create and Display YouTube Iframe ---
            const musicContainer = document.getElementById('music-container');
            musicContainer.innerHTML = ''; // Clear previous content
            if (recommendation.song_embed_url) {
                const iframe = document.createElement('iframe');
                iframe.width = "100%"; // Make it responsive
                iframe.height = "250";
                iframe.src = recommendation.song_embed_url;
                iframe.title = "YouTube video player";
                iframe.frameborder = "0";
                iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";
                iframe.allowFullscreen = true;
                musicContainer.appendChild(iframe);
            }
            document.getElementById('music-rec-text').textContent = ${recommendation.song} by ${recommendation.artist};


            // --- Create and Display Snack Image ---
            const snackContainer = document.getElementById('snack-container');
            snackContainer.innerHTML = ''; // Clear previous content
            if (recommendation.food_image_url) {
                const img = document.createElement('img');
                img.src = recommendation.food_image_url;
                img.alt = recommendation.snack;
                img.onerror = () => {
                    // Fallback if the image fails to load
                    img.src = 'https://placehold.co/500x300/f0f0f0/333?text=Snack+Image';
                };
                snackContainer.appendChild(img);
            }
            document.getElementById('snack-rec-text').textContent = recommendation.snack;


            // --- Show the results section ---
            resultsSection.classList.remove('hidden');
        }
        // === JAVASCRIPT MODIFICATION END ===

        // --- Start the application ---
        window.addEventListener('load', setupWebcam);
    </script>
</body>

</html>